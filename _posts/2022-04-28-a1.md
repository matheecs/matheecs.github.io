---
layout: post
title: "è§£æA1-QP-MPC-Controller"
categories: study
author: "Jixiang Zhang"
---

æˆªæ­¢ç›®å‰ï¼Œå››è¶³æœºå™¨äººçš„è¿åŠ¨æ§åˆ¶æ¶Œç°å‡ºä¸å°‘å¼€æºæ–¹æ¡ˆï¼Œç½—åˆ—å‡ ä¸ª

1. [**Cheetah-Software**](https://github.com/mit-biomimetics/Cheetah-Software)
2. [IHMC-Robotics](https://github.com/GabrielEGC/IHMC-Robotics)
3. [Optimal Control for Switched Systems](https://github.com/leggedrobotics/ocs2)
4. [Representation-Free Model Predictive Control](https://github.com/YanranDing/RF-MPC)

ä¸€ä»¶å€¼å¾—å¼€å¿ƒçš„äº‹ï¼Œå‰å‡ å¤©[YYç¡•](https://www.zhihu.com/people/yyss2037)ä¹Ÿå¼€æºäº†ä¸€å¥—é‡‡ç”¨ GNU Affero General Public License v3.0 åè®®çš„æ–¹æ¡ˆ

- [A1-QP-MPC-Controller ä»“åº“ä¸»é¡µ](https://github.com/ShuoYangRobotics/A1-QP-MPC-Controller)
- [(çŸ¥ä¹)åˆä¸€ä¸ªå¼€æºçš„å››è¶³æœºå™¨äººæ§åˆ¶å™¨](https://zhuanlan.zhihu.com/p/504495840)

ç®€å•æ¥è¯´ï¼ŒA1-QP-MPC-Controller å°±æ˜¯ Cheetah-Software çš„æµ“ç¼©ç²¾åç‰ˆ(ä»£ç é‡æ˜¯å…¶ 1/5 çº¦ 3K è¡Œ)ï¼Œé‡‡ç”¨è½»é‡çº§æ¡†æ¶ï¼Œä»£ç æ˜“è¯»ï¼Œç»“æ„æ¸…æ™°ï¼Œç®€ç›´æ˜¯å…¥é—¨å››è¶³è¿åŠ¨æ§åˆ¶çš„ç¦éŸ³ã€‚

```text
-------------------------------------------------------------------------------
Language                     files          blank        comment           code
-------------------------------------------------------------------------------
C++                             15            451            582           2352
C/C++ Header                    11            261            201            921
Markdown                         1              3              0              2
-------------------------------------------------------------------------------
SUM:                            27            715            783           3275
-------------------------------------------------------------------------------
```

ä¸ Cheetah-Software è‡ªå¸¦ä»¿çœŸå™¨ä¸ä¸€æ ·ï¼ŒA1-QP-MPC-Controller é‡‡ç”¨ç¬¬ä¸‰æ–¹ä»¿çœŸå¹³å°ï¼Œç›®å‰ä»…æ”¯æŒ Gazebo å’Œ Isaac Simã€‚Gazebo ä»¿çœŸæ¯”è¾ƒè€—è®¡ç®—èµ„æºï¼Œå»ºè®®ç”¨å¸¦**ç‹¬ç«‹æ˜¾å¡**çš„è®¡ç®—æœºè·‘ä»¿çœŸï¼

## ä»£ç ç»“æ„

ç±»

<p align="center">
  <img src="images/class_list.png" width="500"/>
</p>

UML

<p align="center">
  <img src="images/a1_uml.png" width="500"/>
</p>

## ç®—æ³•ç†è§£

è°ˆè°ˆä¸ªäººç†è§£ï¼ŒA1-QP-MPC-Controller çŠ¶æ€ä¼°è®¡**ç”¨è¶³åº•åŠ›æ¥è®¡ç®—è§¦åœ°ä¿¡æ¯**ï¼Œè€Œ Cheetah-Software çš„æ–¹æ¡ˆæ²¡æœ‰ä¼°è®¡è§¦åœ°ä¿¡æ¯ï¼Œæ‰€ä»¥ä»çœŸæœºæˆ–ä»¿çœŸæ¥çœ‹ A1-QP-MPC-Controller å¾ˆç¨³ï¼Œä¸”æ”¯æŒä¸Šæ¥¼æ¢¯ã€‚å½“ç„¶ä»£ç ä¹Ÿæœ‰å¾ˆå¤šä¼˜åŒ–ç©ºé—´ï¼Œæ¯”å¦‚ ConvexMpc å¯¹è±¡ä¸éœ€è¦æ¯æ¬¡è®¡ç®—æ—¶éƒ½é‡æ–°ç”Ÿæˆå†é‡Šæ”¾ï¼Œè€ƒè™‘é‡‡ç”¨è½»é‡åŒ–çš„ä»¿çœŸå¹³å°(ä¾‹å¦‚ ODE)ï¼Œè€ƒè™‘ç”¨é”®ç›˜ä»£æ›¿æ‰‹æŸ„ğŸ®æ§åˆ¶æœºå™¨äººã€‚

## å®‰è£…æ–¹æ³•

åŸå§‹ä»“åº“é‡‡ç”¨ Docker å®‰è£…ä¾èµ–ç¯å¢ƒï¼Œå…¶å®ä¸ç”¨ Docker ä¹Ÿèƒ½è·‘ï¼Œåªéœ€è¦æŒ‰ç…§ `A1-QP-MPC-Controller/docker/Dockerfile` æ–‡ä»¶é‡Œçš„æŒ‡ä»¤ä¸€æ­¥æ­¥æ‰§è¡Œã€‚å‡è®¾ä½ å·²ç»å®‰è£…å¥½äº† ROSï¼Œé‚£ä¹ˆè¿˜éœ€è¦å®Œæˆä»¥ä¸‹æ­¥éª¤

**å®‰è£…å¸¸ç”¨è½¯ä»¶**

```bash
$ sudo apt-get update && apt-get install -y \
      vim \
      libatlas-base-dev \
      libeigen3-dev \
      libgoogle-glog-dev \
      libsuitesparse-dev \
      python-catkin-tools \
      python3-matplotlib \
      gfortran \
      autoconf \
      coinor-libipopt-dev \
      libgfortran3 \
      curl \
      libopenmpi-dev \
      apt-utils \
      software-properties-common \
      build-essential \
      libssl-dev \
      ros-${ROS_DISTRO}-ros-control \
      ros-${ROS_DISTRO}-gazebo-ros \
      ros-${ROS_DISTRO}-joy \
      ros-${ROS_DISTRO}-ros-controllers \
      ros-${ROS_DISTRO}-robot-state-publisher
```

**å®‰è£… OSQP**

```bash
cd ~
git clone --recursive https://github.com/oxfordcontrol/osqp
cd osqp
mkdir build
cd build
cmake ..
make -j
sudo make install
```

**å®‰è£… osqp-eigen**

```bash
cd ~
git clone https://github.com/robotology/osqp-eigen.git
cd osqp-eigen
mkdir build
cd build
cmake ..
make -j
sudo make install
```

**å®‰è£… LCM**

```bash
cd ~
git clone https://github.com/lcm-proj/lcm.git
cd lcm
mkdir build
cd build
cmake ..
make -j
sudo make install
```

**ç¼–è¯‘(æ— éœ€å®‰è£…) unitree_legged_sdk & aliengo_sdk**

```bash
cd ~
git clone https://github.com/unitreerobotics/unitree_legged_sdk.git
cd unitree_legged_sdk
git checkout v3.2
mkdir build
cd build
cmake ..
make -j
```

```bash
cd ~
git clone https://github.com/unitreerobotics/aliengo_sdk.git
cd aliengo_sdk
mkdir build
cd build
cmake ..
make -j
```

**é…ç½®ç¯å¢ƒå˜é‡**

ä¿®æ”¹ `~/.bashrc` æ–‡ä»¶ï¼Œæœ«å°¾æ·»åŠ 

```bash
source /opt/ros/${ROS_DISTRO}/setup.bash
source ~/catkin_ws/devel/setup.bash
export UNITREE_LEGGED_SDK_PATH=~/unitree_legged_sdk
export ALIENGO_SDK_PATH=~/aliengo_sdk
#amd64, arm32, arm64
export UNITREE_PLATFORM="amd64"
```

**æœ€åå®‰è£… unitree_ros (å‡è®¾ ROS å·¥ä½œç©ºé—´è·¯å¾„ä¸º `~/catkin_ws`) å’Œ A1-QP-MPC-Controller**

```bash
cd catkin_ws/src
git clone https://github.com/ShuoYangRobotics/unitree_ros.git
git clone https://github.com/ShuoYangRobotics/A1-QP-MPC-Controller.git
cd ~/catkin_ws
catkin_make
```

é¡ºåˆ©æ‰§è¡Œå®Œä»¥ä¸ŠæŒ‡ä»¤åï¼Œå°±å¯ä»¥å¯åŠ¨ç¨‹åºå•¦ã€‚ä»¥å¯åŠ¨ Gazebo ä»¿çœŸä¸ºä¾‹

```bash
# å¯åŠ¨ Gazebo ä»¿çœŸç¯å¢ƒ
$ roslaunch unitree_gazebo normal.launch rname:=a1 wname:=stairs_single
# åˆå§‹åŒ–æœºå™¨äººä½å§¿
$ rosrun unitree_controller unitree_servo # let the robot stretch legs
$ rosrun unitree_controller unitree_move_kinetic # place the robot back to origin
# å¯åŠ¨æ‰‹æŸ„ğŸ®é©±åŠ¨
$ rosrun joy joy_node
# å¯åŠ¨æ§åˆ¶å™¨
$ roslaunch a1_cpp a1_ctrl.launch type:=gazebo solver_type:=mpc # solver_type can be qp or mpc
```

å…¶ä¸­æ‰‹æŸ„çš„ `A` é”®ç”¨æ¥åˆ‡æ¢ stand/tort æ­¥æ€

æœ€åæ„Ÿè°¢ç¡•å“¥å¸¦é¢†å°ä¼™ä¼´å…¥é—¨(keng)~
