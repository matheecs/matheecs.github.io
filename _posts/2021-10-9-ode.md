---
layout: post
title: "物理引擎概念🎮[译]"
categories: study
author: "Jixiang Zhang"
---

原文 [Open Dynamics Engine v0.5 User Guide](https://ode.org/ode-latest-userguide.html)

### 刚体

从仿真的角度来看，一个刚体有各种属性。有些属性会随时间变化：

- 刚体的参考点的位置向量（x,y,z）。参考点必须对应于刚体的质量中心。
- 参考点的线性速度，一个矢量（vx,vy,vz）。
- 刚体的方向，用一个四元数（qs,qx,qy,qz）或旋转矩阵表示。
- 角速度矢量（wx,wy,wz），描述方向如何随时间变化。

其他刚体属性通常是随时间变化的：

- 刚体的质量。
- 质量中心相对于参考点的位置。在目前的实现中，质心和参考点必须重合。
- 惯性矩阵。这是一个3x3矩阵，描述刚体的质量如何围绕质量中心分布。

从概念上讲，每个体都有一个嵌入其中的 x-y-z 坐标框架，它随着体的移动和旋转，如图所示。

![](https://ode.org/pix/body.jpg)

这个坐标框架的原点是刚体的参考点。ODE中的一些数值（向量、矩阵等）是相对于刚体坐标框架而言的，而其他数值则是相对于全局坐标框架而言的。

请注意，刚体的形状不是一个动态属性。只有**碰撞检测**才关心体的详细形状。

##### Island 和禁用刚体

刚体是通过关节相互连接的。一个 Island 是一个不能被拉开的刚体群体。换句话说，每个刚体都以某种方式与 Island 里的其他刚体相连。

仿真时，世界上的每个 Island 都被单独处理。这一点很有用，如果仿真中有 N 个类似的 Island，那么单步计算时间将是 O(N)。

每个刚体都可以被启用或禁用。被禁用的刚体实际上是关闭的，仿真时不被更新。当已知物体不运动或与仿真无关时，禁用刚体是节省计算时间的一种有效方法。

如果一个 Island 有任何启用的刚体，那么 Island 的每个刚体在下一个仿真步骤中都会被启用。因此，要想有效地禁用一个 Island，需要把 Island 的每个刚体都禁用。如果一个被禁用的 Island 被另一个被启用的刚体所接触，那么整个 Island 将被启用，因为一个接触关节将把被启用的刚体与 Island 连接起来。

### 积分器

通过时间对刚体系统进行仿真的过程称为积分。每个积分步骤都将当前时间向前推进一个给定的步长，为新的时间值调整所有刚体的**状态**。在使用任何积分器时，有两个主要问题需要考虑：

- 准确性如何？也就是说，仿真系统的行为与现实生活中发生的情况有多一致？
- 稳定性如何？也就是说，计算错误是否会导致仿真系统的完全非物理性行为？

ODE 目前的积分器是非常稳定的，但是除非步长很小，否则不是特别准确。对于ODE的大多数用途来说，这不是一个问题。ODE 的行为在几乎所有的情况下看起来都是完美的物理现象。然而，在这个精度问题在未来的版本中被解决之前，ODE 不应该被用于定量工程。😄

### 力累加器

在每个积分器步骤之间，用户可以调用函数来**对刚体施加力**。这些力被添加到刚体对象的力累加器中。当下一个积分器步骤发生时，所有应用的力的总和将被用来推动刚体。在每个积分器步骤之后，力累加器被设置为零。

### 关节与约束

在现实生活中，关节是类似铰链的东西，用来连接两个物体。在 ODE 中，关节是非常相似的：它是一种在两个刚体之间强制执行的关系，使它们只能有相对特定的位置和方向。这种关系被称为**约束**，关节和约束这两个词经常被互换使用。图中显示了三种不同的约束类型。

![](https://ode.org/pix/joints.jpg)

积分器每执行一个步长时，所有的关节都被允许对它们所影响的刚体施加**约束力**。这些力的计算是为了使物体的移动能够保持所有的关节关系。

每个关节都有一些控制其几何的参数。一个例子是球窝接头的球窝点的位置。设置关节参数的函数都采用全局坐标，而不是相对于刚体的坐标。这样做的一个结果是，在连接关节之前，关节所连接的刚体必须被正确定位。

### 关节组

关节组是一个特殊的容器，用来容纳世界中的关节。关节可以被添加到一个组中，然后当这些关节不再需要时，整个组的关节可以通过一个函数调用被快速销毁。然而，在整个组被清空之前，组内的单个关节是不能被销毁的。

这对于接触关节来说是最有用的，因为接触点在每个时间步长中都会被分组添加和删除。

### 关节误差与 ERP ｜ 硬约束

当一个关节连接两个刚体时，这些刚体被要求有特定的相对位置和方向。然而，刚体有可能处于不符合关节约束的位置。这种关节错误可能以两种方式发生：

- 如果用户设置了一个体的位置/方向而没有正确设置另一个体的位置/方向。
- 在仿真过程中，错误会悄悄出现，导致刚体偏离所需位置。

下图显示了一个球窝接头的误差例子（球窝没有对准）。

![](https://ode.org/pix/ball-and-socket-bad.jpg)

有一种机制可以减少关节的误差：在每个仿真步骤中，每个关节都会施加一个特殊的力，使其刚体回到正确的对位。这个力是由减少误差参数（error reduction parameter，ERP）控制的，它的值在 [0,1] 之间。

ERP 规定了在下一个仿真步骤中，关节误差的比例将被固定。如果 ERP=0 就不应用纠正力，随着仿真的进行，刚体最终会漂移开来。如果 ERP=1 仿真将试图在下一个时间步骤中修复所有关节误差。然而，不建议设置 ERP=1 因为由于各种内部近似，关节误差将不会被完全固定。推荐使用 ERP=[0.1, 0.8]（默认为 0.2）。

可以设置一个全局的 ERP 值，影响到仿真中的大多数关节。然而有些关节有局部的 ERP 值，控制关节的各个方面。

### 软约束与 CFM

大多数约束在本质上是硬的。这意味着约束条件代表了永远不会被违反的条件。在实践中，约束条件可能被无意中引入系统的错误所违反，但可以设置 ERP 来纠正这些错误。

不是所有的约束都是硬约束。一些软约束被设计成可以违反的。例如，防止碰撞物体穿透的接触约束在默认情况下是硬的，所以它的作用就像碰撞的表面是由钢铁制成的。但它可以被做成软约束，以仿真较软的材料，从而允许两个物体被迫在一起时有一些自然穿透。

有两个参数可以控制硬约束和软约束之间的区别。第一个是已经介绍过的 ERP。第二个是约束力混合（constraint force mixing，CFM）值。

##### Constraint Force Mixing (CFM)

下面是对 CFM 含义的一些技术描述。如果你只想知道它在实践中是如何使用的，那么请跳到下一节。传统上，每个关节的约束方程的形式为

J * v = c

其中 v 是刚体的速度矢量，J 是一个雅可比矩阵，每一个关节从系统中移除一个自由度就有一行，c 是一个右手定则矢量。在下一个时间步长中，计算出一个矢量 lambda，这样施加在刚体上的力就可以保持关节的约束

force = J^T * lambda

ODE 增加了一个新的 twist。ODE 的约束方程有如下形式

J * v = c + CFM * lambda

其中 CFM 是一个对角方阵。CFM 将产生的约束力与产生它的约束混合在一起。CFM 的非零正值允许原始约束方程被违反，违反量与 CFM 乘以执行约束所需的恢复力 lambda 成正比。求解 lambda 可以得到

(J M^-1 J^T + CFM/h) * lambda = c/h

因此，CFM 只是增加了原始系统矩阵的对角线。使用 CFM 的正值有一个额外的好处，就是使系统远离任何奇异点，从而提高分解器的精度。

LM?🤔️

##### 如何使用 ERP和CFM

ERP和CFM 可以在许多关节处独立设置。它们可以设置在接触关节、关节限位和其他各种地方，以控制关节（或关节限位）的海绵度和弹力度。

如果 CFM 被设置为零，约束将是硬的。如果 CFM 被设置为正值，就有可能通过推压来违反约束（例如，对于接触约束，通过强迫两个接触物体在一起）。换句话说，该约束将是软的，而且软度将随着 CFM 的增加而增加。这里实际发生的情况是，约束被允许被违反的程度与 CFM 乘以执行约束所需的恢复力成正比。注意，将 CFM 设置为负值会产生不良的影响，如不稳定。不要这样做。

通过调整 ERP和CFM 的值，你可以实现各种效果。例如，你可以仿真有弹性的约束，两个体的摆动就像被弹簧连接一样。或者你可以仿真更多的海绵状约束，没有振荡。事实上，ERP和CFM 可以被选择为与任何所需的弹簧和阻尼器常数具有相同的效果。如果你有一个弹簧常数 kp 和阻尼常数 kd，那么相应的 ODE 常数

ERP = h * kp / (h * kp + kd)

CFM = 1 / (h * kp + kd)

其中 h 是步长。这些值将给出与用隐式一阶积分仿真的弹簧-阻尼器系统效果一样。

增加 CFM，特别是全局 CFM，可以减少仿真的数值误差。如果系统是接近奇异点，那么这可以明显地提高稳定性。事实上，如果系统表现不佳，首先要做的就是增加全局 CFM。

### 碰撞处理

刚体之间或刚体与静态环境之间的碰撞处理如下。

- 在每个仿真步骤之前，用户调用**碰撞检测**函数来确定什么东西在接触什么。这些函数返回一个接触点的列表。每个接触点指定一个空间位置、一个表面法向量和一个穿透深度。
- 为每个接触关节创建一个特殊的接触点。接触点被赋予关于接触的额外信息，例如接触面存在的摩擦力，它的弹力或柔软程度，以及其他各种属性。
- 接触点被放在一个接触关节组中，这使得它们可以被快速添加到系统中或从系统中移除。仿真速度会随着接触点数量的增加而下降，因此可以使用各种策略来限制接触点的数量。
- 执行一个仿真步长。
- 所有的接触点都从系统中移除。

请注意，不一定要使用内置的碰撞函数，只要提供正确种类的接触点信息，就可以使用其他碰撞检测库，如 [FCL](https://github.com/flexible-collision-library/fcl)。

### 仿真流程

一个典型的仿真器将像这样执行：

- 创建一个动力学世界
- 在动力学世界中创建**刚体**
- 设置所有刚体的状态
- 在动力学世界中创建**关节**
- 将关节连接到刚体上
- 设置所有关节的参数
- 创建一个碰撞世界和碰撞几何对象
- 创建一个关节组来容纳接触的关节
- 循环大逻辑
  - 必要时对刚体施加力
  - 必要时调整关节参数
  - 调用**碰撞检测**
  - 为每个碰撞关节创建一个接触点，并把它放在接触关节组中
  - 执行一个仿真步长
  - 移除接触关节组中的所有关节

### 物理模型

这里讨论了 ODE 中使用的各种方法和近似。

##### 摩擦力近似

![](http://ode.org/wiki/images/4/49/Cone_frottement.jpg)

库仑摩擦模型是一种简单而有效的方法来仿真接触点的摩擦。它是存在于接触点的法向力和切向力之间的一种简单关系。其规则是

| f_T | <= mu * | f_N |

其中 f_N 和 f_T 分别是法向力和切向力，mu 是摩擦系数（通常是 1.0 左右的数字）。这个方程定义了一个**摩擦锥**。想象一个以 f_N 为轴，接触点为顶点的锥体。如果总的摩擦力矢量在锥体内，那么接触就处于粘着模式，摩擦力足以阻止接触面相对于对方的移动。如果力矢量在圆锥体的表面上，那么接触就处于滑动模式，摩擦力通常不足以阻止接触面滑动。因此，参数 mu 规定了切向力与法向力的最大比率。

ODE 的摩擦模型是摩擦锥的近似值，是出于效率的考虑。目前有两个近似值可以选择。

1. mu 的含义被改变了，所以它指定了在一个接触点上可能存在的最大摩擦（切向）力，在任何一个切向摩擦方向。这是相当非物理的，因为它与法向力无关，但它可能是有用的，而且是计算上最便宜的选择。请注意，在这种情况下，mu 是一个力的极限，必须选择适合于仿真的。
2. 摩擦锥由一个与第一和第二摩擦方向对齐的摩擦金字塔来近似。一个进一步的近似是：首先 ODE 计算法向力，假设所有的接触都是无摩擦的。然后，它计算出摩擦（切向）力的最大极限 f_m，来自于

f_m = mu * | f_N |

然后用这些固定的极限值对整个系统进行求解（方式与上述近似值1 相似）。这与真正的摩擦金字塔不同，因为有效的 mu 并不完全固定。这种近似方法更容易使用，因为 mu 是一个无单位的比率，与正常的 Coloumb 摩擦系数相同，因此可以设置为 1.0 左右的恒定值而不考虑具体的仿真。

### References

- [Open Dynamics Engine v0.5 User Guide](https://ode.org/ode-latest-userguide.html)
- [ODE Tutorials](http://demura.net/english)
- [Physically Based Modeling: Principles and Practice](https://www.cs.cmu.edu/~baraff/sigcourse/index.html)